apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: postgres
spec:
  template:
    metadata:
      annotations:
        # Override DBM host configuration for prod environment
        # Use DNS name to match application connection strings for proper DBM-APM correlation
        ad.datadoghq.com/postgres.checks: |
          {
            "postgres": {
              "init_config": {},
              "instances": [
                {
                  "host": "postgres-0.postgres.mcp-agent-prod.svc.cluster.local",
                  "port": 5432,
                  "username": "datadog",
                  "password": "ENC[k8s_secret@mcp-agent-prod/datadog-postgres-credentials/password]",
                  "dbname": "burgerdb",
                  "dbm": true,
                  "dbstrict": true,
                  "query_metrics": {
                    "enabled": true,
                    "run_sync": false,
                    "collection_interval": 10
                  },
                  "query_samples": {
                    "enabled": true,
                    "run_sync": false,
                    "collection_interval": 10,
                    "explain_function": "datadog.explain_statement",
                    "explained_queries_per_hour_per_query": 60,
                    "samples_per_hour_per_query": 15
                  },
                  "query_activity": {
                    "enabled": true,
                    "collection_interval": 10
                  },
                  "collect_schemas": {
                    "enabled": true,
                    "collection_interval": 600
                  },
                  "ssl": "disable",
                  "tags": [
                    "env:prod",
                    "service:postgres",
                    "app:burgers-ai-agent",
                    "database:burgerdb"
                  ],
                  "relations": [
                    {
                      "relation_regex": ".*"
                    }
                  ]
                }
              ]
            }
          }
