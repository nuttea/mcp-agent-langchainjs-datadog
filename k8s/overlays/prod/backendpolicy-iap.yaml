---
# GCPBackendPolicy for IAP - Agent Webapp (Production)
# This policy enables Identity-Aware Proxy (IAP) for user authentication
# on the agent-webapp service accessed via www.platform-engineering-demo.dev
#
# Prerequisites:
# 1. OAuth 2.0 credentials created in Google Cloud Console
# 2. Kubernetes secret 'oauth-client-secret' created with client_id and client_secret
# 3. IAM permissions granted to authorized users (roles/iap.httpsResourceAccessor)
#
# Documentation: /docs/deployment/iap-setup.md
apiVersion: networking.gke.io/v1
kind: GCPBackendPolicy
metadata:
  name: agent-webapp-iap-policy
  namespace: mcp-agent-prod
  labels:
    app: agent-webapp
    environment: prod
    security: iap-enabled
spec:
  # Apply this policy to the agent-webapp service
  targetRef:
    group: ""
    kind: Service
    name: agent-webapp
  # Default backend configuration
  default:
    # IAP Configuration
    iap:
      # Enable Identity-Aware Proxy
      enabled: true
      # Reference to Kubernetes secret containing OAuth credentials
      oauth2ClientSecret:
        name: oauth-client-secret
      # OAuth 2.0 Client ID
      # IMPORTANT: Replace with your actual Client ID from Google Cloud Console
      # Format: 123456789-abcdefghijklmnop.apps.googleusercontent.com
      clientID: 449012790678-o4n20ce420kjuao68mciclp915dlrubj.apps.googleusercontent.com
    # Optional: Configure session affinity for better user experience
    # sessionAffinity:
    #   affinityType: CLIENT_IP
    #   affinityCookieTtlSec: 3600
    # Optional: Configure connection draining for graceful shutdowns
    # connectionDraining:
    #   drainingTimeoutSec: 60
    # Optional: Configure custom health check
    # healthCheck:
    #   checkIntervalSec: 10
    #   timeoutSec: 5
    #   healthyThreshold: 2
    #   unhealthyThreshold: 3
    #   requestPath: /health
    #   port: 80
